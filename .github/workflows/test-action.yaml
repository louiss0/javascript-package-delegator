name: Test Action

on:
  push:
    branches:
      - main
      - dev
jobs:
  log-with-nushell:
    name: Log Env Vars & Test Git Stat with NuShell
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install NuShell
        uses: hustcer/setup-nu@v3
        with:
          version: stable
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_DEPLOY_KEY: ${{ secrets.GORELEASER_DEPLOY_KEY }}
      - name: Ensure REQUIRED_VAR Exists
        shell: nu {0}
        run: |
          if not ($env.GITHUB_TOKEN | in (env).name) {
            print $"üö® GITHUB_TOKEN is missing!"
            exit 1
          }

          if not ($env.GORELEASER_DEPLOY_KEY | in (env).name) {
            print $"üö® GORELEASER_DEPLOY_KEY is missing!"
            exit 1
          }

      - name: Log All Env Vars
        shell: nu {0}
        run: |
          env
          | lines
          | split column "=" key value
          | sort-by key
          | default column value '' # prevent nulls

      - name: Create dummy public key file
        run: |
          echo $env.GORELEASER_DEPLOY_KEY > goreleaser_pubkey

      - name: Test git stat on public key
        shell: nu {0}
        run: |
          let exists = (git status --ignored=no --untracked-files=all --short goreleaser_pubkey | is-empty)
          if exists {
            print $"‚ùå goreleaser_pubkey is not under version control!"
            exit 1
          } else {
            print $"‚úÖ goreleaser_pubkey is tracked by git."
          }

      - name: Print specific vars
        shell: nu {0}
        run: |
          echo $"GORELEASER_DEPLOY_KEY: ($env.GORELEASER_DEPLOY_KEY)"
          echo $"GITHUB_TOKEN: ($env.GITHUB_TOKEN)"
          echo $"REQUIRED_VAR: ($env.REQUIRED_VAR)"
