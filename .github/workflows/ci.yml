name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  lint:
    name: Lint, format, and vet
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify gofmt
        run: |
          set -euo pipefail
          files=$(gofmt -s -l . | grep -Ev '^(vendor/|$)' || true)
          if [[ -n "${files}" ]]; then
            echo "These files are not gofmt-formatted:"
            echo "${files}"
            echo "Run: gofmt -s -w ."
            exit 1
          fi

      - name: Install goimports
        run: go install golang.org/x/tools/cmd/goimports@latest

      - name: Verify goimports
        run: |
          set -euo pipefail
          files=$(goimports -l . | grep -Ev '^(vendor/|$)' || true)
          if [[ -n "${files}" ]]; then
            echo "These files need goimports:"
            echo "${files}"
            echo "Run: goimports -w ."
            exit 1
          fi

      - name: go vet
        run: go vet ./...

      - name: Check go.mod is tidy
        run: |
          set -euo pipefail
          cp go.mod go.mod.bak
          cp go.sum go.sum.bak
          go mod tidy
          if ! diff -u go.mod.bak go.mod >/dev/null || ! diff -u go.sum.bak go.sum >/dev/null; then
            echo "go.mod/go.sum changed after 'go mod tidy'. Please run it locally and commit."
            git --no-pager diff -- go.mod go.sum
            exit 1
          fi

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --timeout=5m --output.text.colors=true --output.text.print-linter-name=true

  test:
    name: Test (Ginkgo) + coverage
    runs-on: ${{ matrix.os }}
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download modules
        run: go mod download

      - name: Install Ginkgo (match module version)
        run: |
          set -euo pipefail
          VER=$(go list -m -f '{{.Version}}' github.com/onsi/ginkgo/v2)
          echo "Installing ginkgo CLI @ ${VER}"
          go install github.com/onsi/ginkgo/v2/ginkgo@"${VER}"

      - name: Run tests with Ginkgo and CI build flags
        run: |
          set -euo pipefail
          # Run tests with ginkgo, excluding build_info, mock, and testutil packages
          ginkgo -r --skip-package build_info,testutil,mock --cover --covermode=atomic --coverprofile=coverage.out --ldflags="-X github.com/louiss0/javascript-package-delegator/build_info.rawCI=true"

      - name: Coverage summary
        run: |
          set -euo pipefail
          total=$(go tool cover -func=coverage.out | awk '/total:/ {print $3}')
          echo "### Test Coverage (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "Total: ${total}" >> $GITHUB_STEP_SUMMARY

      - name: Coverage threshold check
        run: |
          set -euo pipefail
          if ! go tool cover -func=coverage.out | awk '/^total:/ { if ($3+0 < 80) exit 1 }'; then
            echo "❌ Coverage is below 70% threshold (Ginkgo-tested packages only) on ${{ matrix.os }}"
            go tool cover -func=coverage.out | tail -n 1
            exit 1
          fi
          echo "✅ Coverage meets 70% threshold (Ginkgo-tested packages only) on ${{ matrix.os }}"

      - name: Generate HTML coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}
          path: |
            coverage.out
            coverage.html

      - name: Cleanup test artifacts
        run: |
          bash ./scripts/cleanup.sh || true

  docs:
    name: Build docs (Astro)
    runs-on: ubuntu-latest
    needs: [lint]
    defaults:
      run:
        shell: bash
        working-directory: docs
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'docs/pnpm-lock.yaml'

      - name: Verify pnpm availability
        run: pnpm --version

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build docs
        run: pnpm build

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-dist
          path: docs/dist

  build:
    name: Cross-compile smoke builds
    runs-on: ubuntu-latest
    needs: [test]
    strategy:
      fail-fast: true
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          set -euo pipefail
          DATE_RFC3339=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          LDFLAGS="-X github.com/louiss0/javascript-package-delegator/build_info.rawCLI_VERSION=dev -X github.com/louiss0/javascript-package-delegator/build_info.rawGO_MODE=development -X github.com/louiss0/javascript-package-delegator/build_info.rawBUILD_DATE=${DATE_RFC3339} -X github.com/louiss0/javascript-package-delegator/build_info.rawCI=true -s -w"
          mkdir -p dist
          out="dist/jpd-${GOOS}-${GOARCH}"
          if [[ "${GOOS}" == "windows" ]]; then out="${out}.exe"; fi
          go build -trimpath -ldflags "${LDFLAGS}" -o "${out}" ./main.go

      - name: Upload binaries (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: jpd-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/
